syntax = "proto3";

import "google/protobuf/empty.proto";

option java_multiple_files =  true;

package kademlia;

message PingRequest 
{
  Node node = 1;
  string publicKey = 2;
  bytes signature = 3;
}

message PingResponse 
{
  bytes id = 1;
  bool online = 2;
  string publicKey = 3;
  bytes signature = 4;
}

message Node
{
  bytes id = 1;
  string ip = 2;
  uint32 port = 3;
  bytes randomX = 4;
}

message NodeSignature
{
  bytes signature = 1;
}

message Offer
{
  Node node = 1;
  float price = 2;
}

message Transaction
{
  // Tipo 1: inicio de auction | Tipo 2: bid/proposta | Tipo 3: fecho de auction
  bytes id = 1;
  uint32 type = 2;
  Node owner = 3;
  Node broker = 4;
  bytes signature = 5;
  Offer sender = 6;
}
message StoreRequest
{
  Node node = 1;
  bytes key = 2;
  Node value = 3;
  string publicKey = 4;
  bytes signature = 5;
}

message StoreResponse
{
  bytes id = 1;
  bool stored = 2;
  string publicKey = 3;
  bytes signature = 4;
}

message FindNodeRequest
{
  Node node = 1;
  bytes key = 2;
  uint32 k = 3;
  string publicKey = 4;
  bytes signature = 5;
}

// Interativo ou recursivo
message FindNodeResponse
{
  bytes id = 1;
  repeated Node nodes = 2;
  string publicKey = 3;
  repeated NodeSignature ns = 4;
  bytes idSignature = 5;
}

message FindValueRequest
{
  Node node = 1;
  bytes key = 2;
  string publicKey = 3;
  bytes signature = 4;
}

message FindValueResponse
{
  bytes id = 1;
  Node value = 2;
  repeated Node nodes = 3;
  string publicKey = 4;
  bytes signature = 5;
}

message NotifyRequest
{
  bytes serviceId = 1;
  Node node = 2;
  float price = 3;
  string publicKey = 4;
  bytes signature = 5;

}

message NotifyResponse
{
  bool response = 1;
  string publicKey = 2;
  bytes signature = 3;

}

message getPriceRequest
{
  bytes serviceId = 1;
  string publicKey = 2;
  bytes signature = 3;

}

message getPriceResponse
{
  float price = 1;
  string publicKey = 2;
  bytes signature = 3;

}

message sendPriceRequest
{
  bytes serviceId = 1;
  Offer offer = 2;
  string publicKey = 3;
  bytes signature = 4;

}

message sendPriceResponse
{
  bool result = 1;
  string publicKey = 2;
  bytes signature = 3;

}

/*
message initiateServiceRequest
{
  Node owner = 1;
  bytes serviceId = 2;
  repeated Node nodes = 3;
  uint32 time = 4;
  string publicKey = 5;
  bytes signature = 6;

}

message initiateServiceResponse
{
  bool response = 1;
  string publicKey = 2;
  bytes signature = 3;

}


 */
message subscribeRequest
{
  Node node = 1;
  bytes serviceId = 2;
  string publicKey = 3;
  bytes signature = 4;
}

message subscribeResponse
{
  bool response = 1;
  string publicKey = 2;
  bytes signature = 3;
}

/*
message endServiceRequest
{
  Node node =1 ;
  bytes serviceId = 2;
  Offer of = 3;
  string publicKey = 4;
  bytes signature = 5;

}

message endServiceResponse
{
  bool response =1;
  string publicKey = 2;
  bytes signature = 3;
}


 */


service Kademlia
{
  // Unary
  rpc ping(PingRequest) returns (PingResponse);

  // store a [key, value] pair for later retrieval
  rpc store(StoreRequest) returns (StoreResponse);

  // 160-bit key as an argument, returns (IP address, UDP port, Node ID) for each k closest nodes to target id
  rpc findNode(FindNodeRequest) returns (FindNodeResponse);

  // similar to findNode + if RPC recipient received a STORE for the given key then it returns the stored value
  rpc findValue(FindValueRequest) returns (FindValueResponse);

  rpc notify(NotifyRequest) returns (NotifyResponse);

  rpc getPrice(getPriceRequest) returns (getPriceResponse);

  rpc sendPrice(sendPriceRequest) returns (sendPriceResponse);

  //rpc initiateService(initiateServiceRequest) returns (initiateServiceResponse);

  rpc subscribe(subscribeRequest) returns (subscribeResponse);

  //rpc timerOver(timerOverRequest) returns (timerOverResponse);

  //rpc endService(endServiceRequest) returns (endServiceResponse);

}






